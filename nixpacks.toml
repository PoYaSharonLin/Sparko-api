# nixpacks.toml
# Ruby main app + separate Python embedding service

[phases.setup]
  nixPkgs = [
    "...",                                 # keeps auto-detected (ruby, etc.)
    "python312",
    "python312Packages.pip",
    "python312Packages.virtualenv",
    "python312Packages.gunicorn"           # helps the embed process find gunicorn
  ]

[phases.install]
  cmds = [
    # Ruby gems first (most of your deps)
    "bundle install --jobs 4 --retry 3",

    # Then Python venv + your heavy deps (torch, sentence-transformers)
    "python3 -m venv /app/.venv",
    "/app/.venv/bin/pip install --upgrade pip setuptools wheel",
    "/app/.venv/bin/pip install -r requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu"
  ]

# This is the correct syntax — array of provider names
providers = ["...", "ruby", "python"]

# No need for [start] — Railway will use your Procfile automatically